<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Vehicle Tracker - Sessions</title>

  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    #top { padding: 10px; background:#f6f6f6; border-bottom:1px solid #ddd; display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    #map { height: calc(100vh - 80px); }
    .pill { padding: 6px 10px; border: 1px solid #ddd; background:#fff; border-radius: 999px; font-size: 13px; }
    button { padding: 8px 12px; border-radius: 8px; border: 1px solid #333; background: #fff; cursor:pointer; }
    input, select { padding: 8px 10px; border: 1px solid #bbb; border-radius: 8px; }
  </style>
</head>

<body>
  <div id="top">
    <div class="pill"><b>Status:</b> <span id="status">Starting...</span></div>
    <div class="pill"><b>Lat:</b> <span id="lat">-</span></div>
    <div class="pill"><b>Lon:</b> <span id="lon">-</span></div>
    <div class="pill"><b>Age(s):</b> <span id="age">-</span></div>

    <input id="device" value="ESP32-001" />
    <button id="setDevice">Set Device</button>

    <button id="loadSessions">Load Sessions</button>
    <button id="startSession">Start Session</button>
    <button id="stopSession">Stop Session</button>

    <select id="sessionSelect" style="min-width:280px">
      <option value="">(select a session)</option>
    </select>

    <button id="drawPath">Draw Selected Session</button>
    <button id="clearPath">Clear Path</button>
  </div>

  <div id="map"></div>

  <!-- Loads window.__CONFIG__ = { GOOGLE_MAP_API_KEY: "..." } -->
  <script src="/config.js"></script>

  <script>
    const BASE_URL = ""; // same origin
    let DEVICE_ID = "ESP32-001";
    let ACTIVE_SESSION_ID = null;

    const elStatus = document.getElementById("status");
    const elLat = document.getElementById("lat");
    const elLon = document.getElementById("lon");
    const elAge = document.getElementById("age");
    const elDevice = document.getElementById("device");
    const elSessionSelect = document.getElementById("sessionSelect");

    function setStatus(s) { elStatus.textContent = s; }

    // ===================== GOOGLE MAPS =====================
    let map, marker, polyline;

    function loadGoogleMaps() {
      return new Promise((resolve, reject) => {
        if (window.google && window.google.maps) return resolve();

        const key = (window.__CONFIG__ && window.__CONFIG__.GOOGLE_MAP_API_KEY) || "";
        if (!key) return reject(new Error("Missing GOOGLE_MAP_API_KEY"));

        const script = document.createElement("script");
        script.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(key)}`;
        script.async = true;
        script.defer = true;
        script.onload = () => resolve();
        script.onerror = () => reject(new Error("Failed to load Google Maps script"));
        document.head.appendChild(script);
      });
    }

    function initMap() {
      const startLatLng = { lat: 6.9271, lng: 79.8612 };

      map = new google.maps.Map(document.getElementById("map"), {
        center: startLatLng,
        zoom: 13,
        mapTypeId: "roadmap",
      });

      marker = new google.maps.Marker({
        position: startLatLng,
        map,
        title: "Live Position",
      });

      polyline = null;
    }

    function setMarker(lat, lon) {
      if (!map || !marker) return;
      const pos = { lat: Number(lat), lng: Number(lon) };
      marker.setPosition(pos);
      // Optional: keep the marker in view without constantly recentering
      // map.panTo(pos);
    }

    function clearPath() {
      if (polyline) {
        polyline.setMap(null);
        polyline = null;
      }
      setStatus("Cleared");
    }

    function drawPath(latlngs) {
      if (!map) return;

      if (polyline) {
        polyline.setMap(null);
        polyline = null;
      }

      polyline = new google.maps.Polyline({
        path: latlngs, // [{lat, lng}, ...]
        geodesic: true,
        strokeOpacity: 1.0,
        strokeWeight: 4,
      });

      polyline.setMap(map);

      // Fit bounds
      const bounds = new google.maps.LatLngBounds();
      for (const p of latlngs) bounds.extend(p);
      map.fitBounds(bounds, 20); // padding-ish
    }
    // ======================================================

    async function fetchLatest() {
      try {
        const res = await fetch(`${BASE_URL}/api/latest?deviceId=${encodeURIComponent(DEVICE_ID)}`, { cache: "no-store" });
        if (!res.ok) { setStatus("No data"); return; }

        const data = await res.json();
        const latest = data.latest;

        elLat.textContent = Number(latest.lat).toFixed(6);
        elLon.textContent = Number(latest.lon).toFixed(6);
        elAge.textContent = data.ageSeconds ?? "-";

        setMarker(latest.lat, latest.lon);
        setStatus(`Live ✅ (sid=${latest.session_id ?? "-"})`);
      } catch (e) {
        setStatus("Fetch error ❌");
      }
    }

    async function loadSessions() {
      setStatus("Loading sessions...");
      elSessionSelect.innerHTML = `<option value="">(select a session)</option>`;

      try {
        const res = await fetch(`${BASE_URL}/api/sessions?deviceId=${encodeURIComponent(DEVICE_ID)}`, { cache: "no-store" });
        if (!res.ok) { setStatus("Session load error"); return; }

        const data = await res.json();
        ACTIVE_SESSION_ID = data.activeSessionId;

        const sessions = data.sessions || [];
        for (const s of sessions) {
          const opt = document.createElement("option");
          opt.value = s.id;
          const start = new Date(s.started_at).toLocaleString();
          const end = s.ended_at ? new Date(s.ended_at).toLocaleString() : "ACTIVE";
          opt.textContent = `#${s.id} | ${start} -> ${end}${s.is_active ? " ✅" : ""}`;
          elSessionSelect.appendChild(opt);
        }

        if (ACTIVE_SESSION_ID) setStatus(`Sessions loaded ✅ (active #${ACTIVE_SESSION_ID})`);
        else setStatus(`Sessions loaded ✅ (no active)`);
      } catch (e) {
        setStatus("Session fetch error ❌");
      }
    }

    async function startSession() {
      setStatus("Starting session...");
      try {
        const res = await fetch(`${BASE_URL}/api/sessions/start`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ deviceId: DEVICE_ID, title: null })
        });

        const data = await res.json();
        if (!res.ok) { setStatus(data.error || "Start failed"); return; }

        ACTIVE_SESSION_ID = data.session.id;
        setStatus(`Session started ✅ (#${ACTIVE_SESSION_ID}) - device commanded`);
        await loadSessions();
      } catch (e) {
        setStatus("Start error ❌");
      }
    }

    async function stopSession() {
      setStatus("Stopping session...");
      try {
        const res = await fetch(`${BASE_URL}/api/sessions/stop`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ deviceId: DEVICE_ID })
        });

        const data = await res.json();
        if (!res.ok) { setStatus(data.error || "Stop failed"); return; }

        ACTIVE_SESSION_ID = null;
        setStatus(`Session stopped ✅ (device commanded)`);
        await loadSessions();
      } catch (e) {
        setStatus("Stop error ❌");
      }
    }

    async function drawSelectedSession() {
      const sid = Number(elSessionSelect.value || 0);
      if (!sid) { setStatus("Select a session first"); return; }

      setStatus(`Loading session #${sid}...`);
      try {
        const res = await fetch(`${BASE_URL}/api/session-history?sessionId=${sid}&limit=20000`, { cache: "no-store" });
        if (!res.ok) { setStatus("History error"); return; }

        const data = await res.json();
        const points = data.points || [];
        if (points.length < 2) { setStatus("Not enough points"); return; }

        const latlngs = points
          .map(p => ({ lat: Number(p.lat), lng: Number(p.lon) }))
          .filter(x => Number.isFinite(x.lat) && Number.isFinite(x.lng));

        if (latlngs.length < 2) { setStatus("Not enough valid points"); return; }

        drawPath(latlngs);
        setStatus(`Path drawn ✅ (#${sid}, ${latlngs.length} pts)`);
      } catch (e) {
        setStatus("Path fetch error ❌");
      }
    }

    document.getElementById("setDevice").onclick = async () => {
      DEVICE_ID = elDevice.value.trim() || DEVICE_ID;
      setStatus(`Device = ${DEVICE_ID}`);
      await loadSessions();
    };

    document.getElementById("loadSessions").onclick = loadSessions;
    document.getElementById("startSession").onclick = startSession;
    document.getElementById("stopSession").onclick = stopSession;

    document.getElementById("drawPath").onclick = drawSelectedSession;
    document.getElementById("clearPath").onclick = clearPath;

    // Boot
    (async () => {
      try {
        setStatus("Loading Google Maps...");
        await loadGoogleMaps();
        initMap();
        setStatus("Ready ✅");
        fetchLatest();
        loadSessions();
        setInterval(fetchLatest, 1000);
      } catch (e) {
        console.error(e);
        setStatus("Google Maps load error ❌");
      }
    })();
  </script>
</body>
</html>
